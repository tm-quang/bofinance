/**
 * Debt Manager Page - Quản lý Sổ nợ / Cho vay
 * Theo dõi các khoản nợ cần trả và cho vay
 */

import { useEffect, useState, useCallback } from 'react'
import {
    FaPlus,
    FaHandHoldingUsd,
    FaMoneyBillWave,
    FaBalanceScale,
    FaEdit,
    FaTrash,
    FaCheck,
    FaExclamationTriangle,
    FaClock,
    FaHistory,
    FaCalendarAlt,
} from 'react-icons/fa'
import HeaderBar from '../components/layout/HeaderBar'
import FooterNav from '../components/layout/FooterNav'
import { DebtListSkeleton, DebtSummarySkeleton } from '../components/debts/DebtSkeleton'
import { ModalFooterButtons } from '../components/ui/ModalFooterButtons'
import { NumberPadModal } from '../components/ui/NumberPadModal'
import { DateTimePickerModal } from '../components/ui/DateTimePickerModal'
import { useNotification } from '../contexts/notificationContext.helpers'
import { useDialog } from '../contexts/dialogContext.helpers'
import {
    fetchDebts,
    createDebt,
    updateDebt,
    deleteDebt,
    addPayment,
    getDebtSummary,
    markAsPaid,
    type DebtRecord,
    type DebtType,
    type DebtSummary,
    type CreateDebtInput,
} from '../lib/debtService'

type TabType = 'all' | 'borrow' | 'lend'

interface FormData {
    type: DebtType
    person_name: string
    amount: string
    description: string
    due_date: string
}

const formatCurrency = (amount: number): string => {
    return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND',
        maximumFractionDigits: 0,
    }).format(amount)
}

const formatDate = (dateString: string): string => {
    return new Date(dateString).toLocaleDateString('vi-VN', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
    })
}

const parseVNDInput = (value: string): number => {
    const cleanValue = value.replace(/[^\d-]/g, '')
    return parseInt(cleanValue, 10) || 0
}

const formatVNDInput = (value: string): string => {
    const cleanValue = value.replace(/[^\d]/g, '')
    if (!cleanValue) return ''
    const number = parseInt(cleanValue, 10)
    return new Intl.NumberFormat('vi-VN').format(number)
}

export const DebtManagerPage = () => {
    const { success, error: showError } = useNotification()
    const { showConfirm } = useDialog()

    // State
    const [debts, setDebts] = useState<DebtRecord[]>([])
    const [summary, setSummary] = useState<DebtSummary | null>(null)
    const [isLoading, setIsLoading] = useState(true)
    const [activeTab, setActiveTab] = useState<TabType>('all')

    // Form modal state
    const [isFormOpen, setIsFormOpen] = useState(false)
    const [editingDebt, setEditingDebt] = useState<DebtRecord | null>(null)
    const [formData, setFormData] = useState<FormData>({
        type: 'borrow',
        person_name: '',
        amount: '',
        description: '',
        due_date: '',
    })
    const [isSubmitting, setIsSubmitting] = useState(false)
    const [isNumberPadOpen, setIsNumberPadOpen] = useState(false)

    // Payment modal state
    const [paymentModal, setPaymentModal] = useState<{
        isOpen: boolean
        debt: DebtRecord | null
        amount: string
    }>({
        isOpen: false,
        debt: null,
        amount: '',
    })
    const [isPaymentNumberPadOpen, setIsPaymentNumberPadOpen] = useState(false)
    const [dbError, setDbError] = useState<string | null>(null)
    const [isDatePickerOpen, setIsDatePickerOpen] = useState(false)

    // Load data
    const loadData = useCallback(async () => {
        setIsLoading(true)
        setDbError(null)
        try {
            const [debtsData, summaryData] = await Promise.all([
                fetchDebts(),
                getDebtSummary(),
            ])
            setDebts(debtsData)
            setSummary(summaryData)
        } catch (error: unknown) {
            console.error('Error loading debts:', error)
            // Check if table doesn't exist
            const errorMessage = error instanceof Error ? error.message : String(error)
            if (errorMessage.includes('does not exist') || errorMessage.includes('relation') || errorMessage.includes('42P01')) {
                setDbError('Bảng dữ liệu chưa được tạo. Vui lòng chạy SQL script trong Supabase.')
            } else {
                showError('Không thể tải dữ liệu sổ nợ')
            }
        } finally {
            setIsLoading(false)
        }
    }, [showError])

    useEffect(() => {
        loadData()
    }, [loadData])

    // Filter debts by tab
    const filteredDebts = debts.filter((debt) => {
        if (activeTab === 'all') return true
        return debt.type === activeTab
    })

    // Form handlers
    const handleOpenForm = (debt?: DebtRecord) => {
        if (debt) {
            setEditingDebt(debt)
            setFormData({
                type: debt.type,
                person_name: debt.person_name,
                amount: formatVNDInput(debt.amount.toString()),
                description: debt.description || '',
                due_date: debt.due_date ? debt.due_date.split('T')[0] : '',
            })
        } else {
            setEditingDebt(null)
            setFormData({
                type: 'borrow',
                person_name: '',
                amount: '',
                description: '',
                due_date: '',
            })
        }
        setIsFormOpen(true)
    }

    const handleCloseForm = () => {
        setIsFormOpen(false)
        setEditingDebt(null)
        setFormData({
            type: 'borrow',
            person_name: '',
            amount: '',
            description: '',
            due_date: '',
        })
    }

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault()
        if (isSubmitting) return

        const amount = parseVNDInput(formData.amount)
        if (!formData.person_name.trim()) {
            showError('Vui lòng nhập tên người')
            return
        }
        if (amount <= 0) {
            showError('Số tiền phải lớn hơn 0')
            return
        }

        setIsSubmitting(true)
        try {
            const input: CreateDebtInput = {
                type: formData.type,
                person_name: formData.person_name.trim(),
                amount,
                description: formData.description.trim() || undefined,
                due_date: formData.due_date || undefined,
            }

            if (editingDebt) {
                await updateDebt(editingDebt.id, {
                    person_name: input.person_name,
                    amount: input.amount,
                    description: input.description,
                    due_date: input.due_date,
                })
                success('Đã cập nhật khoản nợ!')
            } else {
                await createDebt(input)
                success(formData.type === 'borrow' ? 'Đã thêm khoản nợ!' : 'Đã thêm khoản cho vay!')
            }

            handleCloseForm()
            loadData()
        } catch (error) {
            console.error('Error saving debt:', error)
            showError('Không thể lưu. Vui lòng thử lại.')
        } finally {
            setIsSubmitting(false)
        }
    }

    const handleDelete = async (debt: DebtRecord) => {
        const confirmed = await showConfirm(
            `Xóa khoản ${debt.type === 'borrow' ? 'nợ' : 'cho vay'} với ${debt.person_name}?`
        )
        if (!confirmed) return

        try {
            await deleteDebt(debt.id)
            success('Đã xóa!')
            loadData()
        } catch (error) {
            console.error('Error deleting debt:', error)
            showError('Không thể xóa')
        }
    }

    const handleMarkAsPaid = async (debt: DebtRecord) => {
        const confirmed = await showConfirm(
            `Đánh dấu đã ${debt.type === 'borrow' ? 'trả hết' : 'nhận lại'} ${formatCurrency(debt.remaining_amount)}?`
        )
        if (!confirmed) return

        try {
            await markAsPaid(debt.id)
            success('Đã đánh dấu hoàn tất!')
            loadData()
        } catch (error) {
            console.error('Error marking as paid:', error)
            showError('Không thể cập nhật')
        }
    }

    // Payment handlers
    const handleOpenPaymentModal = (debt: DebtRecord) => {
        setPaymentModal({
            isOpen: true,
            debt,
            amount: '',
        })
    }

    const handleClosePaymentModal = () => {
        setPaymentModal({
            isOpen: false,
            debt: null,
            amount: '',
        })
    }

    const handleAddPayment = async () => {
        if (!paymentModal.debt) return

        const amount = parseVNDInput(paymentModal.amount)
        if (amount <= 0) {
            showError('Số tiền phải lớn hơn 0')
            return
        }
        if (amount > paymentModal.debt.remaining_amount) {
            showError('Số tiền vượt quá số còn lại')
            return
        }

        try {
            await addPayment(paymentModal.debt.id, amount)
            success(`Đã ghi nhận ${paymentModal.debt.type === 'borrow' ? 'trả nợ' : 'nhận lại'} ${formatCurrency(amount)}`)
            handleClosePaymentModal()
            loadData()
        } catch (error) {
            console.error('Error adding payment:', error)
            showError('Không thể ghi nhận thanh toán')
        }
    }

    // Check if debt is overdue
    const isOverdue = (debt: DebtRecord): boolean => {
        if (!debt.due_date || debt.status === 'paid') return false
        return new Date(debt.due_date) < new Date()
    }

    // Get status badge
    const getStatusBadge = (debt: DebtRecord) => {
        if (debt.status === 'paid') {
            return (
                <span className="inline-flex items-center gap-1 rounded-full bg-emerald-100 px-2.5 py-1 text-xs font-semibold text-emerald-700">
                    <FaCheck className="h-3 w-3" />
                    Đã hoàn tất
                </span>
            )
        }
        if (isOverdue(debt)) {
            return (
                <span className="inline-flex items-center gap-1 rounded-full bg-rose-100 px-2.5 py-1 text-xs font-semibold text-rose-700">
                    <FaExclamationTriangle className="h-3 w-3" />
                    Quá hạn
                </span>
            )
        }
        if (debt.status === 'partial') {
            return (
                <span className="inline-flex items-center gap-1 rounded-full bg-amber-100 px-2.5 py-1 text-xs font-semibold text-amber-700">
                    <FaClock className="h-3 w-3" />
                    Đang trả
                </span>
            )
        }
        return (
            <span className="inline-flex items-center gap-1 rounded-full bg-blue-100 px-2.5 py-1 text-xs font-semibold text-blue-700">
                <FaClock className="h-3 w-3" />
                Chưa trả
            </span>
        )
    }

    return (
        <div className="flex h-full flex-col overflow-hidden bg-[#F7F9FC] text-slate-900">
            <HeaderBar variant="page" title="SỔ NỢ" onReload={loadData} isReloading={isLoading} />

            <main className="flex-1 overflow-y-auto overscroll-contain">
                <div className="mx-auto flex w-full max-w-md flex-col gap-4 px-4 pt-2 pb-24 sm:pt-2 sm:pb-28">
                    {/* Header */}
                    <div className="flex items-center justify-between">
                        <div>
                            <h1 className="text-2xl font-bold text-slate-900">Sổ nợ của tôi</h1>
                            <p className="mt-1 text-sm text-slate-500">
                                Quản lý nợ cần trả và cho vay
                            </p>
                        </div>
                        <button
                            onClick={() => handleOpenForm()}
                            className="flex items-center gap-2 rounded-2xl bg-gradient-to-r from-sky-500 to-blue-600 px-4 py-2.5 text-white font-semibold shadow-lg shadow-sky-500/30 hover:from-sky-600 hover:to-blue-700 transition-all active:scale-95"
                        >
                            <FaPlus className="h-5 w-5" />
                            <span className="hidden sm:inline">Thêm mới</span>
                            <span className="sm:hidden">Thêm</span>
                        </button>
                    </div>

                    {/* Database Error State */}
                    {dbError && (
                        <div className="rounded-3xl bg-gradient-to-br from-amber-50 to-orange-50 p-6 shadow-lg border border-amber-200">
                            <div className="flex items-start gap-4">
                                <div className="flex h-12 w-12 shrink-0 items-center justify-center rounded-2xl bg-amber-100">
                                    <FaExclamationTriangle className="h-6 w-6 text-amber-600" />
                                </div>
                                <div className="flex-1">
                                    <h3 className="font-bold text-amber-900 mb-2">Cần thiết lập Database</h3>
                                    <p className="text-sm text-amber-800 mb-4">{dbError}</p>
                                    <div className="rounded-xl bg-white/80 p-4 border border-amber-200">
                                        <p className="text-xs font-semibold text-amber-900 mb-2">Hướng dẫn:</p>
                                        <ol className="text-xs text-amber-800 space-y-1 list-decimal list-inside">
                                            <li>Mở Supabase Dashboard → SQL Editor</li>
                                            <li>Chạy SQL script tạo bảng <code className="bg-amber-100 px-1 rounded">debts</code> và <code className="bg-amber-100 px-1 rounded">debt_payments</code></li>
                                            <li>Quay lại và refresh trang này</li>
                                        </ol>
                                    </div>
                                    <button
                                        onClick={loadData}
                                        className="mt-4 flex items-center gap-2 rounded-xl bg-amber-500 px-4 py-2 text-sm font-semibold text-white shadow-md hover:bg-amber-600 transition active:scale-95"
                                    >
                                        Thử lại
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Summary Stats */}
                    {!dbError && isLoading ? (
                        <DebtSummarySkeleton />
                    ) : summary && (summary.borrow_count > 0 || summary.lend_count > 0) ? (
                        <div className="grid grid-cols-3 gap-2 sm:gap-3">
                            <div className="rounded-2xl bg-gradient-to-br from-rose-50 to-white p-3 sm:p-4 border border-rose-100 shadow-lg overflow-hidden">
                                <div className="flex items-center gap-1.5 sm:gap-2 mb-2">
                                    <div className="h-7 w-7 sm:h-8 sm:w-8 rounded-lg bg-rose-100 flex items-center justify-center shrink-0">
                                        <FaHandHoldingUsd className="h-3.5 w-3.5 sm:h-4 sm:w-4 text-rose-600" />
                                    </div>
                                    <span className="text-[10px] sm:text-xs font-semibold text-rose-600 truncate">Nợ cần trả</span>
                                </div>
                                <p className="text-sm sm:text-lg font-bold text-slate-900 break-words leading-tight">
                                    {formatCurrency(summary.total_borrow)}
                                </p>
                                <p className="text-[10px] sm:text-xs text-rose-600 font-medium mt-0.5">
                                    {summary.borrow_count} khoản
                                </p>
                            </div>
                            <div className="rounded-2xl bg-gradient-to-br from-emerald-50 to-white p-3 sm:p-4 border border-emerald-100 shadow-lg overflow-hidden">
                                <div className="flex items-center gap-1.5 sm:gap-2 mb-2">
                                    <div className="h-7 w-7 sm:h-8 sm:w-8 rounded-lg bg-emerald-100 flex items-center justify-center shrink-0">
                                        <FaMoneyBillWave className="h-3.5 w-3.5 sm:h-4 sm:w-4 text-emerald-600" />
                                    </div>
                                    <span className="text-[10px] sm:text-xs font-semibold text-emerald-600 truncate">Cho vay</span>
                                </div>
                                <p className="text-sm sm:text-lg font-bold text-slate-900 break-words leading-tight">
                                    {formatCurrency(summary.total_lend)}
                                </p>
                                <p className="text-[10px] sm:text-xs text-emerald-600 font-medium mt-0.5">
                                    {summary.lend_count} khoản
                                </p>
                            </div>
                            <div className="rounded-2xl bg-gradient-to-br from-blue-50 to-white p-3 sm:p-4 border border-blue-100 shadow-lg overflow-hidden">
                                <div className="flex items-center gap-1.5 sm:gap-2 mb-2">
                                    <div className="h-7 w-7 sm:h-8 sm:w-8 rounded-lg bg-blue-100 flex items-center justify-center shrink-0">
                                        <FaBalanceScale className="h-3.5 w-3.5 sm:h-4 sm:w-4 text-blue-600" />
                                    </div>
                                    <span className="text-[10px] sm:text-xs font-semibold text-blue-600 truncate">Số dư ròng</span>
                                </div>
                                <p className={`text-sm sm:text-lg font-bold break-words leading-tight ${summary.net_balance >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>
                                    {formatCurrency(Math.abs(summary.net_balance))}
                                </p>
                                {summary.overdue_count > 0 && (
                                    <p className="text-[10px] sm:text-xs text-rose-600 font-medium mt-0.5">
                                        {summary.overdue_count} quá hạn
                                    </p>
                                )}
                            </div>
                        </div>
                    ) : null}

                    {/* Tabs */}
                    {!dbError && (
                        <div className="flex gap-2 rounded-2xl bg-white p-1.5 shadow-md border border-slate-100">
                            {[
                                { key: 'all', label: 'Tất cả' },
                                { key: 'borrow', label: 'Nợ cần trả' },
                                { key: 'lend', label: 'Cho vay' },
                            ].map((tab) => (
                                <button
                                    key={tab.key}
                                    onClick={() => setActiveTab(tab.key as TabType)}
                                    className={`flex-1 rounded-xl px-3 py-2.5 text-sm font-semibold transition-all ${activeTab === tab.key
                                        ? 'bg-gradient-to-r from-sky-500 to-blue-600 text-white shadow-md'
                                        : 'text-slate-600 hover:bg-slate-50'
                                        }`}
                                >
                                    {tab.label}
                                </button>
                            ))}
                        </div>
                    )}

                    {/* Debt List */}
                    {!dbError && isLoading ? (
                        <DebtListSkeleton count={3} />
                    ) : filteredDebts.length === 0 ? (
                        <div className="rounded-3xl bg-gradient-to-br from-white via-slate-50/50 to-white p-8 sm:p-12 text-center shadow-lg border border-slate-100">
                            <div className="mx-auto mb-6 flex h-24 w-24 items-center justify-center rounded-full bg-gradient-to-br from-sky-100 to-blue-100">
                                <FaHandHoldingUsd className="h-12 w-12 text-sky-500" />
                            </div>
                            <h3 className="mb-3 text-xl sm:text-2xl font-bold text-slate-900">
                                {activeTab === 'all' ? 'Chưa có khoản nợ nào' : activeTab === 'borrow' ? 'Không có nợ cần trả' : 'Chưa cho ai vay'}
                            </h3>
                            <p className="mb-6 text-sm text-slate-500">
                                Thêm khoản nợ hoặc cho vay để theo dõi
                            </p>
                            <button
                                onClick={() => handleOpenForm()}
                                className="inline-flex items-center gap-2 rounded-2xl bg-gradient-to-r from-sky-500 to-blue-600 px-6 py-3 text-white font-semibold shadow-lg shadow-sky-500/30 hover:from-sky-600 hover:to-blue-700 transition-all active:scale-95"
                            >
                                <FaPlus className="h-5 w-5" />
                                Thêm khoản đầu tiên
                            </button>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {filteredDebts.map((debt) => {
                                const progressPercent = debt.amount > 0
                                    ? Math.min(100, (debt.paid_amount / debt.amount) * 100)
                                    : 0

                                return (
                                    <div
                                        key={debt.id}
                                        className={`rounded-3xl bg-white p-5 shadow-lg border transition-all ${isOverdue(debt) ? 'border-rose-200 bg-rose-50/30' : 'border-slate-100'
                                            }`}
                                    >
                                        {/* Header */}
                                        <div className="flex items-start justify-between mb-3">
                                            <div className="flex items-center gap-3">
                                                <div className={`h-12 w-12 rounded-2xl flex items-center justify-center ${debt.type === 'borrow'
                                                    ? 'bg-gradient-to-br from-rose-400 to-rose-600'
                                                    : 'bg-gradient-to-br from-emerald-400 to-emerald-600'
                                                    }`}>
                                                    {debt.type === 'borrow' ? (
                                                        <FaHandHoldingUsd className="h-6 w-6 text-white" />
                                                    ) : (
                                                        <FaMoneyBillWave className="h-6 w-6 text-white" />
                                                    )}
                                                </div>
                                                <div>
                                                    <h3 className="font-bold text-slate-900">{debt.person_name}</h3>
                                                    <p className="text-xs text-slate-500">
                                                        {debt.type === 'borrow' ? 'Nợ cần trả' : 'Cho vay'}
                                                    </p>
                                                </div>
                                            </div>
                                            {getStatusBadge(debt)}
                                        </div>

                                        {/* Amount */}
                                        <div className="mb-3">
                                            <p className={`text-xl font-bold ${debt.type === 'borrow' ? 'text-rose-600' : 'text-emerald-600'}`}>
                                                {formatCurrency(debt.remaining_amount)}
                                                {debt.status !== 'paid' && debt.paid_amount > 0 && (
                                                    <span className="text-sm font-normal text-slate-500 ml-2">
                                                        / {formatCurrency(debt.amount)}
                                                    </span>
                                                )}
                                            </p>
                                            {debt.description && (
                                                <p className="text-sm text-slate-500 mt-1 line-clamp-2">{debt.description}</p>
                                            )}
                                        </div>

                                        {/* Progress bar */}
                                        {debt.status !== 'paid' && debt.paid_amount > 0 && (
                                            <div className="mb-3">
                                                <div className="h-2 w-full rounded-full bg-slate-100 overflow-hidden">
                                                    <div
                                                        className={`h-full rounded-full transition-all ${debt.type === 'borrow' ? 'bg-rose-500' : 'bg-emerald-500'
                                                            }`}
                                                        style={{ width: `${progressPercent}%` }}
                                                    />
                                                </div>
                                                <p className="text-xs text-slate-500 mt-1">
                                                    Đã {debt.type === 'borrow' ? 'trả' : 'nhận'}: {formatCurrency(debt.paid_amount)} ({progressPercent.toFixed(0)}%)
                                                </p>
                                            </div>
                                        )}

                                        {/* Footer */}
                                        <div className="flex items-center justify-between pt-3 border-t border-slate-100">
                                            <div className="text-xs text-slate-500">
                                                {debt.due_date ? (
                                                    <span className={isOverdue(debt) ? 'text-rose-600 font-semibold' : ''}>
                                                        Hạn: {formatDate(debt.due_date)}
                                                    </span>
                                                ) : (
                                                    <span>Tạo: {formatDate(debt.created_at)}</span>
                                                )}
                                            </div>
                                            <div className="flex gap-1.5">
                                                {debt.status !== 'paid' && (
                                                    <>
                                                        <button
                                                            onClick={() => handleOpenPaymentModal(debt)}
                                                            className="p-2 rounded-full text-blue-600 hover:bg-blue-50 transition"
                                                            title={debt.type === 'borrow' ? 'Ghi nhận trả nợ' : 'Ghi nhận nhận lại'}
                                                        >
                                                            <FaHistory className="h-4 w-4" />
                                                        </button>
                                                        <button
                                                            onClick={() => handleMarkAsPaid(debt)}
                                                            className="p-2 rounded-full text-emerald-600 hover:bg-emerald-50 transition"
                                                            title="Đánh dấu hoàn tất"
                                                        >
                                                            <FaCheck className="h-4 w-4" />
                                                        </button>
                                                    </>
                                                )}
                                                <button
                                                    onClick={() => handleOpenForm(debt)}
                                                    className="p-2 rounded-full text-slate-600 hover:bg-slate-100 transition"
                                                    title="Chỉnh sửa"
                                                >
                                                    <FaEdit className="h-4 w-4" />
                                                </button>
                                                <button
                                                    onClick={() => handleDelete(debt)}
                                                    className="p-2 rounded-full text-rose-600 hover:bg-rose-50 transition"
                                                    title="Xóa"
                                                >
                                                    <FaTrash className="h-4 w-4" />
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    )}
                </div>
            </main>

            <FooterNav onAddClick={() => handleOpenForm()} />

            {/* Form Modal */}
            {isFormOpen && (
                <div className="fixed inset-0 z-50 flex flex-col bg-[#F7F9FC] overflow-hidden">
                    <HeaderBar
                        variant="page"
                        title={editingDebt ? 'CHỈNH SỬA' : 'THÊM MỚI'}
                        onBack={handleCloseForm}
                    />

                    <main className="flex-1 overflow-y-auto overscroll-contain bg-[#F7F9FC]">
                        <div className="mx-auto w-full max-w-md px-4 pt-2 pb-4">
                            <form onSubmit={handleSubmit} id="debt-form" className="space-y-4">
                                {/* Type selector */}
                                {!editingDebt && (
                                    <div>
                                        <label className="mb-2 block text-sm font-semibold text-slate-700">
                                            Loại <span className="text-rose-500">*</span>
                                        </label>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button
                                                type="button"
                                                onClick={() => setFormData({ ...formData, type: 'borrow' })}
                                                className={`flex items-center justify-center gap-2 rounded-3xl p-4 border-2 transition-all ${formData.type === 'borrow'
                                                    ? 'border-rose-500 bg-rose-50 text-rose-700'
                                                    : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'
                                                    }`}
                                            >
                                                <FaHandHoldingUsd className="h-5 w-5" />
                                                <span className="font-semibold">Nợ cần trả</span>
                                            </button>
                                            <button
                                                type="button"
                                                onClick={() => setFormData({ ...formData, type: 'lend' })}
                                                className={`flex items-center justify-center gap-2 rounded-3xl p-4 border-2 transition-all ${formData.type === 'lend'
                                                    ? 'border-emerald-500 bg-emerald-50 text-emerald-700'
                                                    : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'
                                                    }`}
                                            >
                                                <FaMoneyBillWave className="h-5 w-5" />
                                                <span className="font-semibold">Cho vay</span>
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {/* Person name */}
                                <div>
                                    <label className="mb-2 block text-sm font-semibold text-slate-700">
                                        {formData.type === 'borrow' ? 'Nợ ai?' : 'Cho ai vay?'} <span className="text-rose-500">*</span>
                                    </label>
                                    <input
                                        type="text"
                                        value={formData.person_name}
                                        onChange={(e) => setFormData({ ...formData, person_name: e.target.value })}
                                        className="w-full rounded-3xl border-2 border-slate-200 bg-white p-4 text-base text-slate-900 placeholder:text-slate-400 transition-all focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500/20"
                                        placeholder="Nhập tên người..."
                                        required
                                    />
                                </div>

                                {/* Amount */}
                                <div>
                                    <label className="mb-2 block text-sm font-semibold text-slate-700">
                                        Số tiền <span className="text-rose-500">*</span>
                                    </label>
                                    <div className="relative">
                                        <input
                                            type="text"
                                            value={formData.amount}
                                            onFocus={() => setIsNumberPadOpen(true)}
                                            className="w-full rounded-3xl border-2 border-slate-200 bg-white p-4 pr-12 text-base text-slate-900 placeholder:text-slate-400 transition-all focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500/20 cursor-pointer"
                                            placeholder="Nhập số tiền..."
                                            required
                                            readOnly
                                        />
                                        <span className="absolute right-4 top-1/2 -translate-y-1/2 font-semibold text-slate-500">₫</span>
                                    </div>
                                </div>

                                {/* Due date */}
                                <div>
                                    <label className="mb-2 block text-sm font-semibold text-slate-700">
                                        Ngày hẹn trả (tùy chọn)
                                    </label>
                                    <button
                                        type="button"
                                        onClick={() => setIsDatePickerOpen(true)}
                                        className="w-full rounded-3xl border-2 border-slate-200 bg-white p-4 text-base text-left transition-all focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500/20 flex items-center justify-between"
                                    >
                                        <span className={formData.due_date ? 'text-slate-900' : 'text-slate-400'}>
                                            {formData.due_date
                                                ? new Date(formData.due_date).toLocaleDateString('vi-VN', {
                                                    day: '2-digit',
                                                    month: '2-digit',
                                                    year: 'numeric',
                                                })
                                                : 'Chọn ngày...'}
                                        </span>
                                        <FaCalendarAlt className="h-5 w-5 text-slate-400" />
                                    </button>
                                </div>

                                {/* Description */}
                                <div>
                                    <label className="mb-2 block text-sm font-semibold text-slate-700">
                                        Ghi chú (tùy chọn)
                                    </label>
                                    <textarea
                                        value={formData.description}
                                        onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                                        className="w-full rounded-3xl border-2 border-slate-200 bg-white p-4 text-base text-slate-900 placeholder:text-slate-400 transition-all focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500/20 resize-none"
                                        rows={3}
                                        placeholder="Thêm ghi chú..."
                                    />
                                </div>
                            </form>
                        </div>
                    </main>

                    <ModalFooterButtons
                        onCancel={handleCloseForm}
                        onConfirm={() => { }}
                        confirmText={isSubmitting ? 'Đang lưu...' : editingDebt ? 'Cập nhật' : 'Thêm mới'}
                        isSubmitting={isSubmitting}
                        disabled={isSubmitting}
                        confirmButtonType="submit"
                        formId="debt-form"
                    />
                </div>
            )}

            {/* Number Pad Modal */}
            <NumberPadModal
                isOpen={isNumberPadOpen && isFormOpen}
                onClose={() => setIsNumberPadOpen(false)}
                value={formData.amount}
                onChange={(value) => setFormData({ ...formData, amount: value })}
                onConfirm={() => setIsNumberPadOpen(false)}
            />

            {/* Payment Modal */}
            {paymentModal.isOpen && paymentModal.debt && (
                <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4">
                    {/* Backdrop */}
                    <div
                        className="absolute inset-0 bg-black/70 backdrop-blur-md"
                        onClick={handleClosePaymentModal}
                    />

                    {/* Dialog */}
                    <div className="relative w-full max-w-md rounded-3xl bg-white shadow-[0_20px_60px_rgba(0,0,0,0.3)] p-6">
                        <h3 className="text-xl font-bold text-slate-900 mb-4">
                            {paymentModal.debt.type === 'borrow' ? 'Ghi nhận trả nợ' : 'Ghi nhận nhận lại'}
                        </h3>

                        <div className="space-y-4 mb-6">
                            <p className="text-sm text-slate-600">
                                Số tiền còn lại: <span className="font-bold text-slate-900">{formatCurrency(paymentModal.debt.remaining_amount)}</span>
                            </p>
                            <div>
                                <label className="mb-2 block text-sm font-semibold text-slate-700">
                                    Số tiền {paymentModal.debt.type === 'borrow' ? 'trả' : 'nhận'}
                                </label>
                                <div className="relative">
                                    <input
                                        type="text"
                                        value={paymentModal.amount}
                                        onFocus={() => setIsPaymentNumberPadOpen(true)}
                                        className="w-full rounded-2xl border-2 border-slate-200 bg-white p-4 pr-12 text-base text-slate-900 placeholder:text-slate-400 transition-all focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500/20 cursor-pointer"
                                        placeholder="Nhập số tiền..."
                                        readOnly
                                    />
                                    <span className="absolute right-4 top-1/2 -translate-y-1/2 font-semibold text-slate-500">₫</span>
                                </div>
                            </div>
                        </div>

                        {/* Actions */}
                        <div className="flex gap-3">
                            <button
                                onClick={handleClosePaymentModal}
                                className="flex-1 rounded-xl border-2 border-slate-200 bg-white px-6 py-3.5 text-sm font-semibold text-slate-700 transition hover:bg-slate-50"
                            >
                                Hủy
                            </button>
                            <button
                                onClick={handleAddPayment}
                                className="flex-1 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-3.5 text-sm font-bold text-white shadow-lg transition hover:from-blue-600 hover:to-blue-700 active:scale-[0.98]"
                            >
                                Xác nhận
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Payment Number Pad Modal */}
            <NumberPadModal
                isOpen={isPaymentNumberPadOpen && paymentModal.isOpen}
                onClose={() => setIsPaymentNumberPadOpen(false)}
                value={paymentModal.amount}
                onChange={(value) => setPaymentModal({ ...paymentModal, amount: value })}
                onConfirm={() => setIsPaymentNumberPadOpen(false)}
            />

            {/* Date Picker Modal */}
            <DateTimePickerModal
                isOpen={isDatePickerOpen}
                onClose={() => setIsDatePickerOpen(false)}
                onConfirm={(date) => {
                    setFormData({ ...formData, due_date: date })
                    setIsDatePickerOpen(false)
                }}
                initialDate={formData.due_date}
                showTime={false}
            />
        </div>
    )
}

export default DebtManagerPage
