<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Icon Generator - BOfin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .upload-section {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8f9ff;
            transition: all 0.3s;
        }

        .upload-section:hover {
            background: #f0f2ff;
            border-color: #764ba2;
        }

        .upload-section.dragover {
            background: #e8ebff;
            border-color: #764ba2;
        }

        #fileInput {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 10px;
        }

        .upload-btn:hover {
            transform: scale(1.05);
        }

        .editor-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .editor-section {
                grid-template-columns: 1fr;
            }
        }

        .editor-panel {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 15px;
        }

        .editor-panel h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .canvas-container {
            text-align: center;
            margin-bottom: 20px;
        }

        #editCanvas {
            border: 2px solid #ddd;
            border-radius: 10px;
            max-width: 100%;
            background: white;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-weight: 600;
            color: #555;
        }

        .control-group input[type="color"] {
            width: 100%;
            height: 50px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .control-group input[type="range"] {
            width: 100%;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            min-width: 120px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .preview-section {
            margin-top: 30px;
        }

        .preview-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .preview-item {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .preview-item h3 {
            color: #555;
            margin-bottom: 15px;
            font-size: 1em;
        }

        .preview-icon {
            width: 100%;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            margin-bottom: 15px;
        }

        .download-btn {
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            width: 100%;
        }

        .download-btn:hover {
            background: #059669;
        }

        .info-box {
            background: #e0f2fe;
            border-left: 4px solid #0ea5e9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box p {
            color: #0c4a6e;
            margin: 5px 0;
        }

        .hidden {
            display: none;
        }

        .size-input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            width: 100%;
        }

        .size-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-info {
            background: #3b82f6;
            color: white;
        }

        .btn-info:hover {
            background: #2563eb;
        }

        .preview-bg-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .bg-preview {
            padding: 10px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bg-preview.active {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .preview-icon-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .preview-icon-container.light {
            background: white;
        }

        .preview-icon-container.dark {
            background: #1a1a1a;
        }

        .preview-icon-container.transparent {
            background-image: 
                linear-gradient(45deg, #ccc 25%, transparent 25%),
                linear-gradient(-45deg, #ccc 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #ccc 75%),
                linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        .rotate-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .filter-controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .download-all-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: transform 0.2s;
        }

        .download-all-btn:hover {
            transform: scale(1.05);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üé® PWA Icon Generator</h1>
        
        <div class="info-box">
            <p><strong>H∆∞·ªõng d·∫´n:</strong></p>
            <p>1. T·∫£i ·∫£nh l√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu ch·ªânh s·ª≠a</p>
            <p>2. Ch·ªânh s·ª≠a ·∫£nh: Th√™m/x√≥a m√†u n·ªÅn, xoay/l·∫≠t ·∫£nh, ƒëi·ªÅu ch·ªânh ƒë·ªô s√°ng/t∆∞∆°ng ph·∫£n/b√£o h√≤a</p>
            <p>3. Xem tr∆∞·ªõc icon v·ªõi c√°c k√≠ch th∆∞·ªõc kh√°c nhau tr√™n n·ªÅn s√°ng/t·ªëi/trong su·ªët</p>
            <p>4. T·∫£i xu·ªëng t·ª´ng icon ho·∫∑c t·∫£i t·∫•t c·∫£ (ZIP) v√† l∆∞u v√†o th∆∞ m·ª•c <strong>app_ima</strong></p>
            <p>5. T·∫°o file manifest.json t·ª± ƒë·ªông cho PWA</p>
        </div>

        <div class="upload-section" id="uploadSection">
            <h2>üì§ T·∫£i ·∫£nh l√™n</h2>
            <p style="margin: 20px 0; color: #666;">K√©o th·∫£ ·∫£nh v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</p>
            <input type="file" id="fileInput" accept="image/*">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                Ch·ªçn ·∫£nh
            </button>
        </div>

        <div class="editor-section hidden" id="editorSection">
            <div class="editor-panel">
                <h2>‚úèÔ∏è Ch·ªânh s·ª≠a ·∫£nh</h2>
                <div class="canvas-container">
                    <canvas id="editCanvas"></canvas>
                </div>
                <div class="controls">
                    <div class="control-group">
                        <label>K√≠ch th∆∞·ªõc (px):</label>
                        <div class="size-input-group">
                            <input type="number" id="widthInput" class="size-input" value="512" min="1" max="2048">
                            <input type="number" id="heightInput" class="size-input" value="512" min="1" max="2048">
                        </div>
                    </div>
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('background', this)">M√†u n·ªÅn</button>
                        <button class="tab" onclick="switchTab('transform', this)">Xoay/L·∫≠t</button>
                        <button class="tab" onclick="switchTab('filters', this)">B·ªô l·ªçc</button>
                    </div>

                    <div id="backgroundTab" class="tab-content active">
                        <div class="control-group">
                            <label>M√†u n·ªÅn:</label>
                            <input type="color" id="bgColorInput" value="#ffffff">
                        </div>
                        <div class="control-group">
                            <label>ƒê·ªô trong su·ªët n·ªÅn (0-1):</label>
                            <input type="range" id="bgAlphaInput" min="0" max="1" step="0.1" value="1">
                            <span id="alphaValue">1.0</span>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="applyBackground()">Th√™m m√†u n·ªÅn</button>
                            <button class="btn btn-danger" onclick="removeBackground()">X√≥a m√†u n·ªÅn</button>
                        </div>
                    </div>

                    <div id="transformTab" class="tab-content">
                        <div class="control-group">
                            <label>Xoay ·∫£nh:</label>
                            <div class="rotate-controls">
                                <button class="btn btn-info" onclick="rotateImage(-90)">‚Ü∫ 90¬∞</button>
                                <button class="btn btn-info" onclick="rotateImage(90)">‚Üª 90¬∞</button>
                                <button class="btn btn-info" onclick="flipImage('horizontal')">‚Üî L·∫≠t ngang</button>
                                <button class="btn btn-info" onclick="flipImage('vertical')">‚Üï L·∫≠t d·ªçc</button>
                            </div>
                        </div>
                    </div>

                    <div id="filtersTab" class="tab-content">
                        <div class="filter-controls">
                            <div class="control-group">
                                <label>ƒê·ªô s√°ng: <span id="brightnessValue">0</span></label>
                                <input type="range" id="brightnessInput" min="-100" max="100" value="0" step="1">
                            </div>
                            <div class="control-group">
                                <label>ƒê·ªô t∆∞∆°ng ph·∫£n: <span id="contrastValue">0</span></label>
                                <input type="range" id="contrastInput" min="-100" max="100" value="0" step="1">
                            </div>
                            <div class="control-group">
                                <label>ƒê·ªô b√£o h√≤a: <span id="saturationValue">0</span></label>
                                <input type="range" id="saturationInput" min="-100" max="100" value="0" step="1">
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="applyFilters()">√Åp d·ª•ng b·ªô l·ªçc</button>
                                <button class="btn btn-warning" onclick="resetFilters()">Reset b·ªô l·ªçc</button>
                            </div>
                        </div>
                    </div>

                    <div class="btn-group" style="margin-top: 15px;">
                        <button class="btn btn-success" onclick="resetImage()">Reset t·∫•t c·∫£</button>
                    </div>
                </div>
            </div>

            <div class="editor-panel">
                <h2>üëÅÔ∏è Xem tr∆∞·ªõc</h2>
                <div class="preview-section">
                    <div class="preview-bg-toggle">
                        <div class="bg-preview active" data-bg="light" onclick="changePreviewBg('light', this)">N·ªÅn s√°ng</div>
                        <div class="bg-preview" data-bg="dark" onclick="changePreviewBg('dark', this)">N·ªÅn t·ªëi</div>
                        <div class="bg-preview" data-bg="transparent" onclick="changePreviewBg('transparent', this)">Trong su·ªët</div>
                    </div>
                    <div class="preview-grid" id="previewGrid">
                        <!-- Preview items will be generated here -->
                    </div>
                    <button class="download-all-btn" onclick="downloadAllIcons()">
                        üì¶ T·∫£i t·∫•t c·∫£ icon (ZIP)
                    </button>
                    <button class="download-all-btn" onclick="generateManifest()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        üìÑ T·∫°o manifest.json
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let originalImage = null;
        let currentImage = null;
        const canvas = document.getElementById('editCanvas');
        const ctx = canvas.getContext('2d');
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const editorSection = document.getElementById('editorSection');
        const bgColorInput = document.getElementById('bgColorInput');
        const bgAlphaInput = document.getElementById('bgAlphaInput');
        const alphaValue = document.getElementById('alphaValue');
        const widthInput = document.getElementById('widthInput');
        const heightInput = document.getElementById('heightInput');
        const brightnessInput = document.getElementById('brightnessInput');
        const contrastInput = document.getElementById('contrastInput');
        const saturationInput = document.getElementById('saturationInput');
        const brightnessValue = document.getElementById('brightnessValue');
        const contrastValue = document.getElementById('contrastValue');
        const saturationValue = document.getElementById('saturationValue');

        let rotationAngle = 0;
        let isFlippedHorizontal = false;
        let isFlippedVertical = false;
        let currentFilters = { brightness: 0, contrast: 0, saturation: 0 };
        let currentPreviewBg = 'light';

        // Standard PWA icon sizes
        const iconSizes = [
            { size: 192, name: 'icon-192x192.png' },
            { size: 512, name: 'icon-512x512.png' },
            { size: 180, name: 'apple-touch-icon.png' },
            { size: 144, name: 'icon-144x144.png' },
            { size: 96, name: 'icon-96x96.png' },
            { size: 72, name: 'icon-72x72.png' },
            { size: 48, name: 'icon-48x48.png' }
        ];

        // Update alpha value display
        bgAlphaInput.addEventListener('input', (e) => {
            alphaValue.textContent = parseFloat(e.target.value).toFixed(1);
        });

        // Filter value displays
        brightnessInput.addEventListener('input', (e) => {
            brightnessValue.textContent = e.target.value;
        });

        contrastInput.addEventListener('input', (e) => {
            contrastValue.textContent = e.target.value;
        });

        saturationInput.addEventListener('input', (e) => {
            saturationValue.textContent = e.target.value;
        });

        // Size input handlers
        widthInput.addEventListener('input', () => {
            if (currentImage) {
                resizeCanvas();
                drawImage();
            }
        });

        heightInput.addEventListener('input', () => {
            if (currentImage) {
                resizeCanvas();
                drawImage();
            }
        });

        // File input handler
        fileInput.addEventListener('change', handleFileSelect);

        // Drag and drop handlers
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Vui l√≤ng ch·ªçn file ·∫£nh!');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    currentImage = img;
                    widthInput.value = img.width;
                    heightInput.value = img.height;
                    resizeCanvas();
                    drawImage();
                    uploadSection.classList.add('hidden');
                    editorSection.classList.remove('hidden');
                    generatePreviews();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function resizeCanvas() {
            const width = parseInt(widthInput.value);
            const height = parseInt(heightInput.value);
            canvas.width = width;
            canvas.height = height;
        }

        function drawImage() {
            if (!currentImage) return;

            const width = parseInt(widthInput.value);
            const height = parseInt(heightInput.value);

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            // Save context
            ctx.save();

            // Move to center
            ctx.translate(width / 2, height / 2);

            // Apply rotation
            ctx.rotate((rotationAngle * Math.PI) / 180);

            // Apply flip
            ctx.scale(isFlippedHorizontal ? -1 : 1, isFlippedVertical ? -1 : 1);

            // Draw image
            ctx.drawImage(currentImage, -width / 2, -height / 2, width, height);

            // Restore context
            ctx.restore();
        }

        function applyBackground() {
            if (!currentImage) return;

            const width = parseInt(widthInput.value);
            const height = parseInt(heightInput.value);
            const bgColor = bgColorInput.value;
            const alpha = parseFloat(bgAlphaInput.value);

            // Create temporary canvas
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = width;
            tempCanvas.height = height;
            const tempCtx = tempCanvas.getContext('2d');

            // Draw background
            const rgba = hexToRgba(bgColor, alpha);
            tempCtx.fillStyle = rgba;
            tempCtx.fillRect(0, 0, width, height);

            // Draw image on top
            tempCtx.drawImage(currentImage, 0, 0, width, height);

            // Update current image
            const img = new Image();
            img.onload = () => {
                currentImage = img;
                drawImage();
                generatePreviews();
            };
            img.src = tempCanvas.toDataURL();
        }

        function removeBackground() {
            if (!originalImage) return;

            const width = parseInt(widthInput.value);
            const height = parseInt(heightInput.value);

            // Create temporary canvas
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = width;
            tempCanvas.height = height;
            const tempCtx = tempCanvas.getContext('2d');

            // Draw image
            tempCtx.drawImage(originalImage, 0, 0, width, height);

            // Get image data
            const imageData = tempCtx.getImageData(0, 0, width, height);
            const data = imageData.data;

            // Remove background (make transparent pixels)
            // This is a simple approach - you might want to use a more sophisticated algorithm
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // Simple white/light background removal
                if (r > 240 && g > 240 && b > 240) {
                    data[i + 3] = 0; // Make transparent
                }
            }

            tempCtx.putImageData(imageData, 0, 0);

            // Update current image
            const img = new Image();
            img.onload = () => {
                currentImage = img;
                drawImage();
                generatePreviews();
            };
            img.src = tempCanvas.toDataURL();
        }

        function resetImage() {
            if (!originalImage) return;
            currentImage = originalImage;
            rotationAngle = 0;
            isFlippedHorizontal = false;
            isFlippedVertical = false;
            currentFilters = { brightness: 0, contrast: 0, saturation: 0 };
            brightnessInput.value = 0;
            contrastInput.value = 0;
            saturationInput.value = 0;
            brightnessValue.textContent = '0';
            contrastValue.textContent = '0';
            saturationValue.textContent = '0';
            drawImage();
            generatePreviews();
        }

        function switchTab(tabName, element) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            if (element) {
                element.classList.add('active');
            }
        }

        function rotateImage(angle) {
            rotationAngle += angle;
            rotationAngle = rotationAngle % 360;
            drawImage();
            generatePreviews();
        }

        function flipImage(direction) {
            if (direction === 'horizontal') {
                isFlippedHorizontal = !isFlippedHorizontal;
            } else {
                isFlippedVertical = !isFlippedVertical;
            }
            drawImage();
            generatePreviews();
        }

        function applyFilters() {
            if (!currentImage) return;

            const width = parseInt(widthInput.value);
            const height = parseInt(heightInput.value);
            const brightness = parseInt(brightnessInput.value);
            const contrast = parseInt(contrastInput.value);
            const saturation = parseInt(saturationInput.value);

            currentFilters = { brightness, contrast, saturation };

            // Create temporary canvas
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = width;
            tempCanvas.height = height;
            const tempCtx = tempCanvas.getContext('2d');

            // Draw image
            tempCtx.drawImage(currentImage, 0, 0, width, height);

            // Apply filters
            const imageData = tempCtx.getImageData(0, 0, width, height);
            const data = imageData.data;

            // Apply brightness and contrast
            const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
            for (let i = 0; i < data.length; i += 4) {
                // Brightness
                data[i] = Math.max(0, Math.min(255, data[i] + brightness));
                data[i + 1] = Math.max(0, Math.min(255, data[i + 1] + brightness));
                data[i + 2] = Math.max(0, Math.min(255, data[i + 2] + brightness));

                // Contrast
                data[i] = Math.max(0, Math.min(255, factor * (data[i] - 128) + 128));
                data[i + 1] = Math.max(0, Math.min(255, factor * (data[i + 1] - 128) + 128));
                data[i + 2] = Math.max(0, Math.min(255, factor * (data[i + 2] - 128) + 128));

                // Saturation
                if (saturation !== 0) {
                    const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                    const satFactor = 1 + (saturation / 100);
                    data[i] = Math.max(0, Math.min(255, gray + satFactor * (data[i] - gray)));
                    data[i + 1] = Math.max(0, Math.min(255, gray + satFactor * (data[i + 1] - gray)));
                    data[i + 2] = Math.max(0, Math.min(255, gray + satFactor * (data[i + 2] - gray)));
                }
            }

            tempCtx.putImageData(imageData, 0, 0);

            // Update current image
            const img = new Image();
            img.onload = () => {
                currentImage = img;
                drawImage();
                generatePreviews();
            };
            img.src = tempCanvas.toDataURL();
        }

        function resetFilters() {
            brightnessInput.value = 0;
            contrastInput.value = 0;
            saturationInput.value = 0;
            brightnessValue.textContent = '0';
            contrastValue.textContent = '0';
            saturationValue.textContent = '0';
            currentFilters = { brightness: 0, contrast: 0, saturation: 0 };
            
            // Reload original image
            if (originalImage) {
                const width = parseInt(widthInput.value);
                const height = parseInt(heightInput.value);
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = width;
                tempCanvas.height = height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(originalImage, 0, 0, width, height);
                
                const img = new Image();
                img.onload = () => {
                    currentImage = img;
                    drawImage();
                    generatePreviews();
                };
                img.src = tempCanvas.toDataURL();
            }
        }

        function changePreviewBg(bg, element) {
            currentPreviewBg = bg;
            document.querySelectorAll('.bg-preview').forEach(el => {
                el.classList.remove('active');
            });
            if (element) {
                element.classList.add('active');
            }
            generatePreviews();
        }

        function generatePreviews() {
            if (!currentImage) return;

            const previewGrid = document.getElementById('previewGrid');
            previewGrid.innerHTML = '';

            iconSizes.forEach(({ size, name }) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';

                const container = document.createElement('div');
                container.className = `preview-icon-container ${currentPreviewBg}`;
                
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                canvas.className = 'preview-icon';
                const ctx = canvas.getContext('2d');

                // Apply transformations
                ctx.save();
                ctx.translate(size / 2, size / 2);
                ctx.rotate((rotationAngle * Math.PI) / 180);
                ctx.scale(isFlippedHorizontal ? -1 : 1, isFlippedVertical ? -1 : 1);
                ctx.drawImage(currentImage, -size / 2, -size / 2, size, size);
                ctx.restore();

                container.appendChild(canvas);

                const h3 = document.createElement('h3');
                h3.textContent = `${size}x${size}`;

                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'download-btn';
                downloadBtn.textContent = 'T·∫£i xu·ªëng';
                downloadBtn.onclick = () => downloadIcon(size, name);

                previewItem.appendChild(h3);
                previewItem.appendChild(container);
                previewItem.appendChild(downloadBtn);

                previewGrid.appendChild(previewItem);
            });
        }

        function downloadIcon(size, filename) {
            if (!currentImage) return;

            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');

            // Apply transformations
            ctx.save();
            ctx.translate(size / 2, size / 2);
            ctx.rotate((rotationAngle * Math.PI) / 180);
            ctx.scale(isFlippedHorizontal ? -1 : 1, isFlippedVertical ? -1 : 1);
            ctx.drawImage(currentImage, -size / 2, -size / 2, size, size);
            ctx.restore();

            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }

        async function downloadAllIcons() {
            if (!currentImage) return;

            if (typeof JSZip === 'undefined') {
                alert('Th∆∞ vi·ªán JSZip ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet.');
                return;
            }

            const zip = new JSZip();
            const promises = [];

            iconSizes.forEach(({ size, name }) => {
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');

                // Apply transformations
                ctx.save();
                ctx.translate(size / 2, size / 2);
                ctx.rotate((rotationAngle * Math.PI) / 180);
                ctx.scale(isFlippedHorizontal ? -1 : 1, isFlippedVertical ? -1 : 1);
                ctx.drawImage(currentImage, -size / 2, -size / 2, size, size);
                ctx.restore();

                const promise = new Promise((resolve) => {
                    canvas.toBlob((blob) => {
                        zip.file(name, blob);
                        resolve();
                    }, 'image/png');
                });
                promises.push(promise);
            });

            await Promise.all(promises);

            zip.generateAsync({ type: 'blob' }).then((content) => {
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'pwa-icons.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }

        function generateManifest() {
            const manifest = {
                "name": "BOfin App",
                "short_name": "BOfin",
                "description": "BOfin - Theo d√µi chi ti√™u, t·ªëi ∆∞u t√†i ch√≠nh",
                "start_url": "/",
                "display": "standalone",
                "background_color": "#ffffff",
                "theme_color": "#10b981",
                "icons": iconSizes.map(({ size, name }) => ({
                    "src": `/${name}`,
                    "sizes": `${size}x${size}`,
                    "type": "image/png",
                    "purpose": "any maskable"
                }))
            };

            const blob = new Blob([JSON.stringify(manifest, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'manifest.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
    </script>
</body>
</html>
